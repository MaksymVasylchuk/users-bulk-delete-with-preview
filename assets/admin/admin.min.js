!function(e){"use strict";const{__:t,_x:s,_n:a,_nx:c}=wp.i18n,r="#search_users_form";let n=1;function l(t,s){e(t).select2({width:"400px",placeholder:s}).on("select2:select select2:unselect",(function(){i(e(this))}))}function i(t){0===t.next(".select2-container").find(".select2-selection--multiple .select2-selection__rendered").children(".select2-selection__choice").length?e(".select2-selection--multiple").css("height","35px"):e(".select2-selection--multiple").css("height","auto")}function o(t){e("#notices").html(""),e(".form-step").hide(),e("#step-"+t).show(),e(".step_icon").removeAttr("disabled").removeClass("btn-primary").addClass("btn-default"),e("#step_icon_"+t).removeAttr("disabled").removeClass("btn-default").addClass("btn-primary")}function d(t){e(t+" :input").each((function(){const s=e(this),a=s.attr("id");s.removeClass("is-invalid is-valid"),e(t+" #"+a+"+.invalid-feedback").html("")}))}function u(s){var a,c;f(),d(r),s.data&&s.data.errors?(a=r,c=s.data.errors,d(a),c&&e.each(c,(function(t,s){t=t.replace(/\./g,"_");const c=e(a+" #"+t);c.removeClass("is-valid").addClass("is-invalid"),c.parent().find(".invalid-feedback").html(s)}))):function(t){const s=e("<div>",{class:"notice notice-error is-dismissible"}),a=e("<p>").text(t),c=e("<button>",{class:"notice-dismiss",html:'<span class="screen-reader-text">Dismiss this notice.</span>',click:()=>s.hide()});s.append(a,c),e("#notices").html(s)}(s.data.message||t("An unexpected error occurred.","users-bulk-delete-with-preview"))}function p(){e("#page_loader").show()}function h(){e("#deleteProgressBar").hide()}function g(){e(".previous_step").prop("disabled",!1),e(".export-users-button").prop("disabled",!1),e(".deleteButton").prop("disabled",!1)}function f(){e("#page_loader").hide()}e(document).ready((function(){e("#user_search").select2({placeholder:t("Search for users","users-bulk-delete-with-preview"),width:"400px",ajax:{url:myAjax.ajaxurl,type:"POST",dataType:"json",delay:250,data:t=>({action:"search_users",q:t.term,nonce:e("#search_user_existing_nonce").val()}),processResults:e=>(d(r),{results:e.data.results})}}).on("select2:select select2:unselect",(function(){i(e(this))})),e(".select2-selection--multiple").css("height","35px"),e("#user_meta").select2({width:"400px",ajax:{url:myAjax.ajaxurl,type:"POST",dataType:"json",delay:250,data:t=>({action:"search_usermeta",q:t.term,nonce:e("#search_user_meta_nonce").val()}),processResults:e=>({results:e.data})},placeholder:t("Select meta field","users-bulk-delete-with-preview"),minimumInputLength:1}),l("#user_role",t("Select user roles","users-bulk-delete-with-preview")),l("#products",t("Select products that bought user","users-bulk-delete-with-preview")),e(".select2-selection--multiple").css("height","35px"),e("#registration_date").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy-mm-dd",placeholder:t("Select registration date","users-bulk-delete-with-preview")}),function(){e(".previous_step").click((()=>{n--,o(n)})),e("#filter_type").change((function(){const t=e(this).val();switch(e(".select_existing_form, .find_users_form, .woocommerce_filters_form").hide(),t){case"select_existing":e(".select_existing_form").show();break;case"find_users":e(".find_users_form").show();break;case"find_users_by_woocommerce_filters":e(".woocommerce_filters_form").show()}})).trigger("change"),e(document).on("click",".preview_before_remove",(function(t){t.preventDefault(),p(),e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:e(r).serialize(),success:function(t){f(),t.success?(!function(t){e.fn.DataTable.isDataTable("#userTable")&&e("#userTable").DataTable().clear().destroy();let s=e("#userTable").DataTable({data:t,responsive:!0,columns:[{title:'<input type="checkbox" id="select-all">',data:"checkbox",orderable:!1,searchable:!1},{title:dataTableLang.id,data:"ID"},{title:dataTableLang.username,data:"user_login"},{title:dataTableLang.email,data:"user_email"},{title:dataTableLang.registered,data:"user_registered"},{title:dataTableLang.role,data:"user_role"},{title:dataTableLang.assignContent,data:"select",orderable:!1,searchable:!1}],language:{emptyTable:dataTableLang.emptyTable,info:dataTableLang.info,infoEmpty:dataTableLang.infoEmpty,infoFiltered:dataTableLang.infoFiltered,lengthMenu:dataTableLang.lengthMenu,loadingRecords:dataTableLang.loadingRecords,processing:dataTableLang.processing,search:dataTableLang.search,zeroRecords:dataTableLang.zeroRecords},order:[[1,"asc"]],lengthMenu:[[10,25,50,75,100,250,500,-1],[10,25,50,75,100,250,500,"All"]],initComplete:function(){e('input[type="search"]').addClass("custom-search-class"),e('select[name="userTable_length"]').addClass("custom-select-class")},createdRow:function(t){e(t).find("select.user-select").addClass("custom-select-class")}});(function(t){const s=e(t[0].select).html();e("#generalSelect").html(s).select2(),e(".user-select").select2({width:"200px"}),e("#select-all").on("click",(function(){const t=e("#userTable").DataTable().rows({search:"applied"}).nodes();e('input[type="checkbox"]',t).prop("checked",this.checked)})),e("#userTable tbody").on("click","input.user-checkbox",(function(){if(!this.checked){const t=e("#select-all").get(0);t&&t.checked&&"indeterminate"in t&&(t.indeterminate=!0)}})),e("#generalSelect").on("change",(function(){const t=e(this).val();e(".user-select").val(t).trigger("change")}))})(t),s.on("draw",(function(){e(".user-select").each((function(){e(this).data("select2")&&e(this).select2("destroy")})),e(".user-select").select2({width:"200px"})})),e(window).trigger("resize")}(t.data),n=2,o(n)):u(t)},error:f})}));let t=0,s=10;function a(){const t=e("#select_users_for_delete").serializeArray();let s={};return t.forEach((e=>{const t=e.name.match(/users\[(\d+)\]\[(\w+)\]/);if(t){const[a,c,r]=t;s[c]=s[c]||{},s[c][r]=e.value}})),Object.values(s)}function c(s,a,r,n){e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:{action:e("#delete_users_action").val(),delete_users_nonce:e("#delete_users_nonce").val(),users:s},success:function(o){if(o.success)if(t+=s.length,l(t,n),t<n){let s=a.slice(t,t+r);e("#user_delete_success_list").append(o.data.template),c(s,a,r,n)}else i(o,a);else d(o)},error:function(e,t,s){console.error("AJAX error:",t,s),d()}})}function l(t,s){const a=t/s*100;e("#progressBarInner").css("width",a+"%"),e("#deletedCount").text(`${t} / ${s} (${Math.round(a)}%)`)}function i(t,s){g(),h(),e("#user_delete_success_list").append(t.data.template);let a=`Success! All selected users (${s.length}) were removed!`;e("#user_delete_success_heading").html(a),n=3,o(n)}function d(e=null){g(),h(),e&&u(e)}e(document).on("click",".deleteButton",(()=>{e("#confirmModal").modal("show")})),e(document).on("click","#confirmDelete",(()=>{e("#confirmModal").modal("hide"),e("#deleteProgressBar").show(),e("#progressBarInner").css("width","0%"),e(".previous_step").prop("disabled",!0),e(".export-users-button").prop("disabled",!0),e(".deleteButton").prop("disabled",!0);let r=a(),n=r.length;s=n>10?10:n<5?1:5,t=0,c(r.slice(0,s),r,s,n)})),e(document).on("click",".export-users-button",(function(t){t.preventDefault(),p(),e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:{action:"custom_export_users",export_users_nonce:e("#export_users_nonce").val(),users:e(".user-checkbox:checked").serializeArray()},success:function(t){if(t.success){var s=t.data.file_url;window.location.href=s,setTimeout((function(){e.ajax({url:ajaxurl,type:"POST",data:{action:"delete_exported_file",nonce:myAjax.ajaxurl,file_path:t.data.file_path},success:function(e){f()},error:f})}),1e3)}else u(t)},error:function(e){f()}})}))}(),e("#selectAllUsers").on("change",(function(){e(this).is(":checked")?(p(),e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:{action:"search_users",q:"",nonce:e("#search_user_existing_nonce").val(),select_all:!0},success:function(t){f();const s=t.data.results.map((t=>{const s=new Option(t.text,t.id,!0,!0);return e("#user_search").append(s).trigger("change"),t.id}));e("#user_search").val(s).trigger("change"),e("#user_search").trigger("select2:select")},error:function(e){console.log("Error fetching users"),f()}})):(e("#user_search").empty().trigger("change").val(null).trigger("change"),e("#user_search").trigger("select2:unselect"))})),e("#selectAllProducts").on("change",(function(){e(this).is(":checked")?(e("#products > option").prop("selected","selected"),e("#products").trigger("change")):(e("#products > option").removeAttr("selected"),e("#products").trigger("change"))})),e("#selectAllSubscriptions").on("change",(function(){e(this).is(":checked")?(e("#subscriptions > option").prop("selected","selected"),e("#subscriptions").trigger("change")):(e("#subscriptions > option").removeAttr("selected"),e("#subscriptions").trigger("change"))}))}))}(jQuery);