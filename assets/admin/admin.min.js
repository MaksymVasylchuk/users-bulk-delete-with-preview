!function(e){"use strict";let{__:t,_x:s,_n:r,_nx:l}=wp.i18n,c="#search_users_form",a=1;function i(t,s){e(t).select2({width:"400px",placeholder:s}).on("select2:select select2:unselect",function(){n(e(this))})}function n(t){0===t.next(".select2-container").find(".select2-selection--multiple .select2-selection__rendered").children(".select2-selection__choice").length?e(".select2-selection--multiple").css("height","35px"):e(".select2-selection--multiple").css("height","auto")}function o(t){e("#notices").html(""),e(".form-step").hide(),e("#step-"+t).show(),e(".step_icon").removeAttr("disabled").removeClass("btn-primary").addClass("btn-default"),e("#step_icon_"+t).removeAttr("disabled").removeClass("btn-default").addClass("btn-primary")}function u(t){e(t+" :input").each(function(){let s=e(this),r=s.attr("id");s.removeClass("is-invalid is-valid"),e(t+" #"+r+"+.invalid-feedback").html("")})}function d(s){if(g(),u(c),s.data&&s.data.errors){var r,l;r=c,l=s.data.errors,u(r),l&&e.each(l,function(t,s){t=t.replace(/\./g,"_");let l=e(r+" #"+t);l.removeClass("is-valid").addClass("is-invalid"),l.parent().find(".invalid-feedback").html(s)})}else!function t(s){let r=e("<div>",{class:"notice notice-error is-dismissible"}),l=e("<p>").text(s),c=e("<button>",{class:"notice-dismiss",html:'<span class="screen-reader-text">Dismiss this notice.</span>',click:()=>r.hide()});r.append(l,c),e("#notices").html(r)}(s.data.message||t("An unexpected error occurred.","wp_user_bulk_delete_with_preview"))}function p(){e("#page_loader").show()}function h(){e("#deleteProgressBar").hide()}function f(){e(".previous_step").prop("disabled",!1),e(".export-users-button").prop("disabled",!1),e(".deleteButton").prop("disabled",!1)}function g(){e("#page_loader").hide()}e(document).ready(function(){e("#user_search").select2({placeholder:t("Search for users","wp_user_bulk_delete_with_preview"),width:"400px",ajax:{url:myAjax.ajaxurl,type:"POST",dataType:"json",delay:250,data:t=>({action:"search_users",q:t.term,nonce:e("#search_user_existing_nonce").val()}),processResults:e=>(u(c),{results:e.data.results})}}).on("select2:select select2:unselect",function(){n(e(this))}),e(".select2-selection--multiple").css("height","35px"),e("#user_meta").select2({width:"400px",ajax:{url:myAjax.ajaxurl,type:"POST",dataType:"json",delay:250,data:t=>({action:"search_usermeta",q:t.term,nonce:e("#search_user_meta_nonce").val()}),processResults:e=>({results:e.data})},placeholder:t("Select meta field","wp_user_bulk_delete_with_preview"),minimumInputLength:1}),i("#user_role",t("Select user roles","wp_user_bulk_delete_with_preview")),i("#products",t("Select products that bought user","wp_user_bulk_delete_with_preview")),e(".select2-selection--multiple").css("height","35px"),e("#registration_date").datepicker({changeMonth:!0,changeYear:!0,dateFormat:"yy-mm-dd",placeholder:t("Select registration date","wp_user_bulk_delete_with_preview")}),function s(){e(".previous_step").click(()=>{o(--a)}),e("#filter_type").change(function(){let t=e(this).val();switch(e(".select_existing_form, .find_users_form, .woocommerce_filters_form").hide(),t){case"select_existing":e(".select_existing_form").show();break;case"find_users":e(".find_users_form").show();break;case"find_users_by_woocommerce_filters":e(".woocommerce_filters_form").show()}}).trigger("change"),e(document).on("click",".preview_before_remove",function(s){s.preventDefault(),p(),e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:e(c).serialize(),success:function(s){var r;g(),s.success?(r=s.data,e.fn.DataTable.isDataTable("#userTable")&&e("#userTable").DataTable().clear().destroy(),e("#userTable").DataTable({data:r,columns:[{title:'<input type="checkbox" id="select-all">',data:"checkbox",orderable:!1,searchable:!1},{title:t("ID","wp_user_bulk_delete_with_preview"),data:"ID"},{title:t("Username","wp_user_bulk_delete_with_preview"),data:"user_login"},{title:t("Email","wp_user_bulk_delete_with_preview"),data:"user_email"},{title:t("Registered","wp_user_bulk_delete_with_preview"),data:"user_registered"},{title:t("Role","wp_user_bulk_delete_with_preview"),data:"user_role"},{title:t("Assign related content to user","wp_user_bulk_delete_with_preview"),data:"select",orderable:!1,searchable:!1}],order:[[1,"asc"]],lengthMenu:[[10,25,50,75,100,250,500,-1],[10,25,50,75,100,250,500,"All"]],initComplete:function(){e('input[type="search"]').addClass("custom-search-class"),e('select[name="userTable_length"]').addClass("custom-select-class")},createdRow:function(t){e(t).find("select.user-select").addClass("custom-select-class")}}).on("draw",function(){e(".user-select").each(function(){e(this).data("select2")&&e(this).select2("destroy")}),e(".user-select").select2({width:"200px"})}),function t(s){let r=e(s[0].select).html();e("#generalSelect").html(r).select2(),e(".user-select").select2({width:"200px"}),e("#select-all").on("click",function(){let t=e("#userTable").DataTable().rows({search:"applied"}).nodes();e('input[type="checkbox"]',t).prop("checked",this.checked)}),e("#userTable tbody").on("click","input.user-checkbox",function(){if(!this.checked){let t=e("#select-all").get(0);t&&t.checked&&"indeterminate"in t&&(t.indeterminate=!0)}}),e("#generalSelect").on("change",function(){let t=e(this).val();e(".user-select").val(t).trigger("change")})}(r),o(a=2)):d(s)},error:g})});let r=0,l=10;function i(e=null){f(),h(),e&&d(e)}e(document).on("click",".deleteButton",()=>{e("#confirmModal").modal("show")}),e(document).on("click","#confirmDelete",()=>{e("#confirmModal").modal("hide"),e("#deleteProgressBar").show(),e("#progressBarInner").css("width","0%"),e(".previous_step").prop("disabled",!0),e(".export-users-button").prop("disabled",!0),e(".deleteButton").prop("disabled",!0);let t=function t(){let s=e("#select_users_for_delete").serializeArray(),r={};return s.forEach(e=>{let t=e.name.match(/users\[(\d+)\]\[(\w+)\]/);if(t){let[s,l,c]=t;r[l]=r[l]||{},r[l][c]=e.value}}),Object.values(r)}(),s=t.length;l=s>10?10:s<5?1:5,r=0;(function t(s,l,c,n){e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:{action:e("#delete_users_action").val(),delete_users_nonce:e("#delete_users_nonce").val(),users:s},success:function(u){if(u.success){if(function t(s,r){let l=s/r*100;e("#progressBarInner").css("width",l+"%"),e("#deletedCount").text(`${s} / ${r} (${Math.round(l)}%)`)}(r+=s.length,n),r<n){let d=l.slice(r,r+c);e("#user_delete_success_list").append(u.data.template),t(d,l,c,n)}else{var p,g;let m;p=u,g=l,f(),h(),e("#user_delete_success_list").append(p.data.template),m=`Success! All selected users (${g.length}) were removed!`,e("#user_delete_success_heading").html(m),o(a=3)}}else i(u)},error:function(e,t,s){console.error("AJAX error:",t,s),i()}})})(t.slice(0,l),t,l,s)}),e(document).on("click",".export-users-button",function(t){t.preventDefault(),p(),e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:{action:"custom_export_users",export_users_nonce:e("#export_users_nonce").val(),users:e(".user-checkbox:checked").serializeArray()},success:function(t){if(t.success){var s=t.data.file_url;window.location.href=s,setTimeout(function(){e.ajax({url:ajaxurl,type:"POST",data:{action:"delete_exported_file",nonce:myAjax.ajaxurl,file_path:t.data.file_path},success:function(e){g()},error:g})},1e3)}else d(t)},error:function(e){g()}})})}(),e("#selectAllUsers").on("change",function(){e(this).is(":checked")?e.ajax({url:myAjax.ajaxurl,type:"POST",dataType:"json",data:{action:"search_users",q:"",nonce:e("#search_user_existing_nonce").val(),select_all:!0},success:function(t){let s=t.data.results.map(t=>{let s=new Option(t.text,t.id,!0,!0);return e("#user_search").append(s).trigger("change"),t.id});e("#user_search").val(s).trigger("change"),e("#user_search").trigger("select2:select")},error:()=>console.log("Error fetching users")}):(e("#user_search").empty().trigger("change").val(null).trigger("change"),e("#user_search").trigger("select2:unselect"))}),e("#selectAllProducts").on("change",function(){e(this).is(":checked")?(e("#products > option").prop("selected","selected"),e("#products").trigger("change")):(e("#products > option").removeAttr("selected"),e("#products").trigger("change"))}),e("#selectAllSubscriptions").on("change",function(){e(this).is(":checked")?(e("#subscriptions > option").prop("selected","selected"),e("#subscriptions").trigger("change")):(e("#subscriptions > option").removeAttr("selected"),e("#subscriptions").trigger("change"))})})}(jQuery);